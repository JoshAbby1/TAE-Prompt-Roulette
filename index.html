<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TAE ‚Äî Prompt Roulette</title>
<meta name="theme-color" content="#A8B48F" />
<style>
:root{
  --bg:#A8B48F; --panel:#B7C19C; --text:#3B2E2A; --muted:#5A4A44;
  --btn:#3B2E2A; --btnText:#F3EFED; --border:rgba(59,46,42,.25)
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center}
.container{width:100%;max-width:560px;padding:22px}
h1{text-align:center;margin:6px 0 10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:rgba(255,255,255,.6);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-weight:700}
button{border:0;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;font-size:16px}
.btn{background:var(--btn);color:var(--btnText)}
.btn.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
.small{font-size:13px;color:var(--muted)}
label{font-weight:700;margin:10px 0 6px;display:block}
textarea{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:15px;min-height:120px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.controls button{flex:1}
.center{text-align:center}
#timerWrap{height:10px;background:rgba(255,255,255,.45);border-radius:999px;overflow:hidden;margin-top:8px;border:1px solid var(--border);display:none}
#timerBar{height:100%;width:100%;background:var(--btn);transition:width .2s linear}
.result{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:10px}
.score{font-weight:900}
#status{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <h1>üé≤ Prompt Roulette</h1>
  <div id="status">status: loading JS‚Ä¶</div>

  <!-- round setup -->
  <div class="card" id="setup">
    <div class="row">
      <span class="badge" id="chipScene">Scene: ‚Äî</span>
      <span class="badge" id="chipOutfit">Outfit: ‚Äî</span>
      <span class="badge" id="chipVibe">Vibe: ‚Äî</span>
    </div>
    <div class="controls" style="margin-top:12px">
      <button class="btn" onclick="spin()">üîÄ Spin prompt parts</button>
      <button id="startBtn" class="btn ghost" onclick="startRound()" disabled>‚ñ∂Ô∏è Start 30s round</button>
    </div>
    <p class="small" style="margin-top:8px">Spin to get a random <b>scene</b>, <b>outfit</b>, and <b>vibe</b>. Then you‚Äôve got <b>30 seconds</b> to write the best TAE prompt. Frank will judge you.</p>
    <div id="timerWrap"><div id="timerBar"></div></div>
  </div>

  <!-- writing area -->
  <div class="card" id="play" style="display:none">
    <label for="prompt">Your prompt (go! 30 seconds)</label>
    <textarea id="prompt" placeholder="Write your full prompt here‚Ä¶ (ratio, scene, outfit, lighting, camera, mood, action, negatives)"></textarea>
    <div class="controls">
      <button class="btn" onclick="submitPrompt()">üìù Submit to Frank</button>
      <button class="btn ghost" onclick="giveUp()">‚èπ Give up</button>
    </div>
    <p class="small" id="timeLeft">30s left</p>
  </div>

  <!-- results -->
  <div class="card" id="results" style="display:none">
    <div class="result">
      <div><span class="score" id="score">‚Äî/10</span></div>
      <div id="quip" style="margin-top:6px">‚Äî</div>
      <div id="tips" class="small" style="margin-top:6px"></div>
    </div>
    <div class="controls">
      <button class="btn" onclick="playAgain()">üîÅ Play again</button>
      <button id="copyBtn" class="btn ghost" onclick="copyPrompt()">üìã Copy my prompt</button>
    </div>
  </div>

  <p class="small center">TAE colours ‚Ä¢ Built for The AI Edit</p>
</div>

<script>
/* ======== DATA ======== */
const SCENES=["laundromat at midnight","Tesco car park in rain","neon alley, puddles","moody cafe window","underground station platform","rooftop at golden hour","arcade with RGB lights","foggy street under sodium lights","gritty stairwell","seaside promenade at dusk","parking garage, harsh top light"];
const OUTFITS=["grey tracksuit & chain","black cargos, clean trainers","North Face hoodie","oversized bomber & tee","denim jacket, white tee","all-black techwear","puffer, cargos, cap","neutral streetwear set","tracksuit + backpack"];
const VIBES=["cinematic chaos","dreamy aesthetic","confident","moody","funny","Y2K glossy","high fashion editorial","grungy film","clean commercial"];

/* ======== ELEMENTS ======== */
const chipScene=document.getElementById('chipScene');
const chipOutfit=document.getElementById('chipOutfit');
const chipVibe=document.getElementById('chipVibe');
const startBtn=document.getElementById('startBtn');
const setupCard=document.getElementById('setup');
const playCard=document.getElementById('play');
const promptEl=document.getElementById('prompt');
const timeLeft=document.getElementById('timeLeft');
const timerWrap=document.getElementById('timerWrap');
const timerBar=document.getElementById('timerBar');
const resultsCard=document.getElementById('results');
const scoreEl=document.getElementById('score');
const quipEl=document.getElementById('quip');
const tipsEl=document.getElementById('tips');
const statusEl=document.getElementById('status');

statusEl.textContent='status: JS ready';

/* ======== STATE ======== */
let current={scene:null,outfit:null,vibe:null};
let timer=null, remaining=30;

/* ======== HELPERS ======== */
function r(a){return a[Math.floor(Math.random()*a.length)]}
function show(el,on=true){el.style.display=on?'':'none'}
function resetTimer(){
  clearInterval(timer);
  remaining=30;
  timeLeft.textContent='30s left';
  timerBar.style.width='100%';
}
function startTimer(){
  timerWrap.style.display='block';
  const total=30;
  const start=Date.now();
  timer=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-start)/1000);
    remaining=Math.max(0,total-elapsed);
    timeLeft.textContent=remaining+'s left';
    timerBar.style.width=(remaining/total*100)+'%';
    if(remaining<=0){
      clearInterval(timer);
      submitPrompt();
    }
  },200);
}

/* ======== UI ACTIONS ======== */
function spin(){
  current.scene=r(SCENES);
  current.outfit=r(OUTFITS);
  current.vibe=r(VIBES);
  chipScene.textContent='Scene: '+current.scene;
  chipOutfit.textContent='Outfit: '+current.outfit;
  chipVibe.textContent='Vibe: '+current.vibe;
  startBtn.disabled=false;
  statusEl.textContent='status: spun ‚úÖ';
}

function startRound(){
  if(!current.scene||!current.outfit||!current.vibe){statusEl.textContent='status: spin first';return;}
  show(setupCard,false); show(playCard,true);
  promptEl.value=''; promptEl.focus();
  resetTimer(); startTimer();
  statusEl.textContent='status: round started';
}

async function submitPrompt(){
  clearInterval(timer);
  statusEl.textContent="status: grading‚Ä¶";
  quipEl.textContent="Frank‚Äôs thinking‚Ä¶";
  show(playCard,false); show(resultsCard,true);
  await gradeWithFrank();
}
function giveUp(){
  clearInterval(timer);
  promptEl.value='(gave up)';
  submitPrompt();
}
function playAgain(){
  show(resultsCard,false); show(setupCard,true);
  startBtn.disabled=true;
  chipScene.textContent='Scene: ‚Äî'; chipOutfit.textContent='Outfit: ‚Äî'; chipVibe.textContent='Vibe: ‚Äî';
  timerWrap.style.display='none';
  statusEl.textContent='status: ready';
}
async function copyPrompt(){
  try{await navigator.clipboard.writeText(promptEl.value||''); const b=document.getElementById('copyBtn'); const old=b.textContent; b.textContent='‚úÖ Copied'; setTimeout(()=>b.textContent=old,900);}catch{}
}

/* ======== CALL BACKEND ======== */
async function gradeWithFrank(){
  scoreEl.textContent='‚Ä¶/10'; tipsEl.textContent='';
  try{
    const res=await fetch('/api/grade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      scene:current.scene,outfit:current.outfit,vibe:current.vibe,prompt:(promptEl.value||'').trim()
    })});
    if(!res.ok){
      const err=await res.text();
      scoreEl.textContent='‚Äî/10';
      quipEl.textContent='Frank‚Äôs sulking.';
      tipsEl.textContent=err||'Server error. Did you add GEMINI_API_KEY and redeploy?';
      statusEl.textContent='status: API error';
      return;
    }
    const data=await res.json();
    scoreEl.textContent=(data.score??6)+'/10';
    quipEl.textContent=data.quip||'Frank shrugs.';
    tipsEl.innerHTML=(Array.isArray(data.tips)&&data.tips.length)?'Tips:<br>‚Ä¢ '+data.tips.join('<br>‚Ä¢ '):'';
    statusEl.textContent='status: graded ‚úÖ';
  }catch(e){
    console.error(e);
    scoreEl.textContent='‚Äî/10';
    quipEl.textContent='Frank fell off the trolley.';
    tipsEl.textContent='Network error. Is /api/grade deployed?';
    statusEl.textContent='status: network error';
  }
}
</script>
</body>
</html>
