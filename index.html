<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TAE ‚Äî Prompt Roulette</title>
<meta name="theme-color" content="#A8B48F" />
<style>
:root{
  --bg:#A8B48F; --panel:#B7C19C; --text:#3B2E2A; --muted:#5A4A44;
  --btn:#3B2E2A; --btnText:#F3EFED; --border:rgba(59,46,42,.25); --white:#fff
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center}
.container{width:100%;max-width:560px;padding:22px}
h1{text-align:center;margin:6px 0 10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:rgba(255,255,255,.75);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-weight:700}
button{border:0;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;font-size:16px}
.btn{background:var(--btn);color:var(--btnText)}
.btn.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
.small{font-size:13px;color:var(--muted)}
label{font-weight:700;margin:10px 0 6px;display:block}
textarea{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:15px;min-height:120px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.controls button{flex:1}
.center{text-align:center}
#timerWrap{height:10px;background:rgba(255,255,255,.45);border-radius:999px;overflow:hidden;margin-top:8px;border:1px solid var(--border);display:none}
#timerBar{height:100%;width:100%;background:var(--btn);transition:width .2s linear}
.result{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:10px}
.score{font-weight:900}
#status{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
.helper{background:var(--white);border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:10px}
.helper h3{margin:0 0 6px;font-size:14px}
.hints{display:flex;flex-wrap:wrap;gap:8px}
.hint{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv .badge{background:#fff}
</style>
</head>
<body>
<div class="container">
  <h1>üé≤ Prompt Roulette</h1>
  <div id="status">status: ready</div>

  <!-- setup -->
  <div class="card" id="setup">
    <div class="row">
      <span class="badge" id="chipScene">Scene: ‚Äî</span>
      <span class="badge" id="chipOutfit">Outfit: ‚Äî</span>
      <span class="badge" id="chipVibe">Vibe: ‚Äî</span>
    </div>
    <div class="controls" style="margin-top:12px">
      <button class="btn" onclick="spin()">üîÄ Spin prompt parts</button>
      <button id="startBtn" class="btn ghost" onclick="startRound()" disabled>‚ñ∂Ô∏è Start 30s round</button>
    </div>
    <p class="small" style="margin-top:8px">Spin to get a random <b>scene</b>, <b>outfit</b>, and <b>vibe</b>. Then you‚Äôve got <b>30 seconds</b> to write the best TAE prompt. Frank will judge you.</p>
    <div id="timerWrap"><div id="timerBar"></div></div>
  </div>

  <!-- writing -->
  <div class="card" id="play" style="display:none">
    <!-- keep choices visible here -->
    <div class="kv">
      <span class="badge" id="drawScene">Scene: ‚Äî</span>
      <span class="badge" id="drawOutfit">Outfit: ‚Äî</span>
      <span class="badge" id="drawVibe">Vibe: ‚Äî</span>
    </div>

    <!-- helper block -->
    <div class="helper">
      <h3>Need a hand?</h3>
      <div class="hints" id="hints">
        <span class="hint" onclick="addToPrompt('Ratio: 9:16')">Ratio: 9:16</span>
        <span class="hint" onclick="addToPrompt('Camera: 85mm lens, eye-level')">Camera: 85mm</span>
        <span class="hint" onclick="addToPrompt('Lighting: cinematic LED glow, soft shadows')">Lighting: cinematic</span>
        <span class="hint" onclick="addToPrompt('Mood: confident')">Mood: confident</span>
        <span class="hint" onclick="addToPrompt('Action: walking toward camera')">Action: walking</span>
        <span class="hint" onclick="addToPrompt('Background: soft depth, bokeh neon')">Background: bokeh neon</span>
        <span class="hint" onclick="addToPrompt('Negative Prompts: cartoonish, blurry, extra fingers, watermark')">Negatives</span>
      </div>
      <div class="controls" style="margin-top:10px">
        <button class="btn ghost" onclick="insertScaffold()">üß© Insert prompt scaffold</button>
      </div>
    </div>

    <label for="prompt" style="margin-top:12px">Your prompt (go! 30 seconds)</label>
    <textarea id="prompt" placeholder="Write your full prompt here‚Ä¶ (ratio, scene, outfit, lighting, camera, mood, action, negatives)"></textarea>
    <div class="controls">
      <button class="btn" onclick="submitPrompt()">üìù Submit to Frank</button>
      <button class="btn ghost" onclick="giveUp()">‚èπ Give up</button>
    </div>
    <p class="small" id="timeLeft">30s left</p>
  </div>

  <!-- results -->
  <div class="card" id="results" style="display:none">
    <div class="result">
      <div><span class="score" id="score">‚Äî/10</span></div>
      <div id="quip" style="margin-top:6px">‚Äî</div>
      <div id="tips" class="small" style="margin-top:6px"></div>
    </div>
    <div class="controls">
      <button class="btn" onclick="playAgain()">üîÅ Play again</button>
      <button id="copyBtn" class="btn ghost" onclick="copyPrompt()">üìã Copy my prompt</button>
    </div>
  </div>

  <p class="small center">TAE colours ‚Ä¢ Built for The AI Edit</p>
</div>

<script>
/* ===== DATA ===== */
const SCENES=["laundromat at midnight","Tesco car park in rain","neon alley, puddles","moody cafe window","underground station platform","rooftop at golden hour","arcade with RGB lights","foggy street under sodium lights","gritty stairwell","seaside promenade at dusk","parking garage, harsh top light"];
const OUTFITS=["grey tracksuit & chain","black cargos, clean trainers","North Face hoodie","oversized bomber & tee","denim jacket, white tee","all-black techwear","puffer, cargos, cap","neutral streetwear set","tracksuit + backpack"];
const VIBES=["cinematic chaos","dreamy aesthetic","confident","moody","funny","Y2K glossy","high fashion editorial","grungy film","clean commercial"];

/* ===== ELTS ===== */
const chipScene=document.getElementById('chipScene');
const chipOutfit=document.getElementById('chipOutfit');
const chipVibe=document.getElementById('chipVibe');
const drawScene=document.getElementById('drawScene');
const drawOutfit=document.getElementById('drawOutfit');
const drawVibe=document.getElementById('drawVibe');
const startBtn=document.getElementById('startBtn');
const setupCard=document.getElementById('setup');
const playCard=document.getElementById('play');
const promptEl=document.getElementById('prompt');
const timeLeft=document.getElementById('timeLeft');
const timerWrap=document.getElementById('timerWrap');
const timerBar=document.getElementById('timerBar');
const resultsCard=document.getElementById('results');
const scoreEl=document.getElementById('score');
const quipEl=document.getElementById('quip');
const tipsEl=document.getElementById('tips');
const statusEl=document.getElementById('status');

/* ===== STATE ===== */
let current={scene:null,outfit:null,vibe:null};
let timer=null, remaining=30;

/* ===== HELPERS ===== */
function r(a){return a[Math.floor(Math.random()*a.length)]}
function show(el,on=true){el.style.display=on?'':'none'}
function resetTimer(){clearInterval(timer);remaining=30;timeLeft.textContent='30s left';timerBar.style.width='100%'}
function startTimer(){
  timerWrap.style.display='block';
  const total=30, start=Date.now();
  timer=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-start)/1000);
    remaining=Math.max(0,total-elapsed);
    timeLeft.textContent=remaining+'s left';
    timerBar.style.width=(remaining/total*100)+'%';
    if(remaining<=0){clearInterval(timer);submitPrompt();}
  },200);
}

/* ===== LOCAL SCORING (fallback & guard) ===== */
function localScore(prompt){
  const txt=(prompt||'').trim();
  const lines=txt.split(/\n/).filter(s=>s.trim()).length;
  const words=txt.split(/\s+/).filter(Boolean).length;
  let feats=0;
  [/ratio/i,/camera|lens/i,/lighting|light/i,/mood/i,/action/i,/negative/i,/background|scene/i,/outfit/i]
    .forEach(re=>{ if(re.test(txt)) feats++; });
  let base=3;
  if (lines>=2 || words>25) base=5;
  if (words>40) base=6;
  if (words>60) base=7;
  if (feats>=5) base+=2; else if (feats>=3) base+=1;
  base=Math.max(3, Math.min(10, base));
  if (lines>=2 && base<5) base=5;
  return base;
}

/* ===== UI ACTIONS ===== */
function spin(){
  current.scene=r(SCENES); current.outfit=r(OUTFITS); current.vibe=r(VIBES);
  chipScene.textContent='Scene: '+current.scene;
  chipOutfit.textContent='Outfit: '+current.outfit;
  chipVibe.textContent='Vibe: '+current.vibe;
  startBtn.disabled=false;
  statusEl.textContent='status: spun ‚úÖ';
}
function startRound(){
  if(!current.scene||!current.outfit||!current.vibe){statusEl.textContent='status: spin first';return;}
  // mirror choices on the play screen
  drawScene.textContent='Scene: '+current.scene;
  drawOutfit.textContent='Outfit: '+current.outfit;
  drawVibe.textContent='Vibe: '+current.vibe;

  show(setupCard,false); show(playCard,true);
  promptEl.value=''; promptEl.focus(); resetTimer(); startTimer();
  statusEl.textContent='status: round started';
}
function addToPrompt(text){
  const add = (promptEl.value ? promptEl.value.replace(/\s+$/,'') + '\n' : '') + text;
  promptEl.value = add;
  promptEl.focus();
}
function insertScaffold(){
  const scaffold =
`Ratio: 9:16
Outfit: ${current.outfit}
Scene: ${current.scene}
Background: add depth and texture consistent with the scene
Camera: 85mm lens, eye-level
Lighting: cinematic LED glow, soft shadow
Mood: ${current.vibe}
Action: (what are they doing?)
Negative Prompts: cartoonish, blurry, extra fingers, watermark`;
  promptEl.value = scaffold;
  promptEl.focus();
}
async function submitPrompt(){
  clearInterval(timer);
  statusEl.textContent="status: grading‚Ä¶";
  show(playCard,false); show(resultsCard,true);
  await gradeWithFrank();
}
function giveUp(){clearInterval(timer);promptEl.value='(gave up)';submitPrompt();}
function playAgain(){
  show(resultsCard,false); show(setupCard,true);
  startBtn.disabled=true;
  chipScene.textContent='Scene: ‚Äî'; chipOutfit.textContent='Outfit: ‚Äî'; chipVibe.textContent='Vibe: ‚Äî';
  timerWrap.style.display='none'; statusEl.textContent='status: ready';
}
async function copyPrompt(){
  try{await navigator.clipboard.writeText(promptEl.value||''); const b=document.getElementById('copyBtn'); const old=b.textContent; b.textContent='‚úÖ Copied'; setTimeout(()=>b.textContent=old,900);}catch{}
}

/* ===== BACKEND CALL ===== */
async function gradeWithFrank(){
  scoreEl.textContent='‚Ä¶/10'; tipsEl.textContent=''; quipEl.textContent='Frank‚Äôs thinking‚Ä¶';

  const body={scene:current.scene,outfit:current.outfit,vibe:current.vibe,prompt:(promptEl.value||'').trim()};

  const render = (score, quip, tips=[])=>{
    scoreEl.textContent = `${score}/10`;
    quipEl.textContent  = quip || "Not bad.";
    tipsEl.innerHTML    = tips.length ? ('Tips:<br>‚Ä¢ '+tips.slice(0,3).join('<br>‚Ä¢ ')) : '';
  };

  try{
    const res = await fetch('/api/grade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});

    if(!res.ok){
      const s = localScore(body.prompt);
      const q = s>=8 ? "Solid stuff ‚Äî proper effort." : s>=5 ? "Decent, bit safe though." : "Barely a prompt, mate.";
      render(s,q);
      statusEl.textContent='status: graded (fallback) ‚úÖ';
      return;
    }

    const data = await res.json();
    let s = parseInt(data.score,10);
    if (!Number.isFinite(s) || s<=0) s = localScore(body.prompt);
    if ((body.prompt.split(/\n/).filter(Boolean).length>=2) && s<5) s=5;
    const q = data.quip || (s>=8 ? "Strong prompt." : s>=5 ? "Decent, push it further." : "Needs work.");
    render(Math.max(3,Math.min(10,s)), q, Array.isArray(data.tips)?data.tips:[]);
    statusEl.textContent='status: graded ‚úÖ';

  }catch(e){
    const s = localScore(body.prompt);
    const q = s>=8 ? "Strong effort ‚Äî I‚Äôll allow it." : s>=5 ? "Decent, tighten it up." : "That‚Äôs weak tea, mate.";
    render(s, q);
    statusEl.textContent='status: graded (offline) ‚úÖ';
  }
}
</script>
</body>
</html>
